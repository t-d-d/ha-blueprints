blueprint:
  name: WiFi-Anchored Presence
  description: >
    The definitive presence tracker (Stale GPS Fix).
    
    1. ANCHORS you to 'Home' when WiFi is connected.
    2. RELEASES you to GPS when you leave.
    3. SCENARIO 2: Handles Alien WiFi with Stale GPS detection (inflates accuracy + pings).
    4. SCENARIO 3: Trust & Verify (Grace Period -> Away -> Ping).
    
    REQUIRED: Companion App with 'WiFi Connection' sensor enabled.
  domain: automation
  input:
    gps_tracker:
      name: Companion App Tracker
      description: The main GPS entity (e.g. device_tracker.pixel_7).
      selector:
        entity:
          domain: device_tracker
          integration: mobile_app
    wifi_sensor:
      name: WiFi Connection Sensor (SSID)
      description: Android = 'sensor.[name]_wifi_connection', iOS = 'sensor.[name]_ssid'
      selector:
        entity:
          domain: sensor
          integration: mobile_app
    home_ssids:
      name: Home SSIDs
      description: Comma-separated list of your home networks.
      selector:
        text:
    grace_period:
      name: Grace Period (Before marking Away)
      description: Time to wait for router reboots before marking 'Away' (Scenario 3).
      default: 120
      selector:
        number:
          min: 0
          max: 600
          unit_of_measurement: seconds
    ping_delay:
      name: Getaway Period (Before GPS Ping)
      description: >
        Time to wait AFTER marking 'Away' before requesting a GPS update. 
        Gives the user time to drive away from the house zone.
      default: 180
      selector:
        number:
          min: 0
          max: 600
          unit_of_measurement: seconds

# ----------------------------------------------------------------
# AUTOMATION CONFIGURATION
# ----------------------------------------------------------------
mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input gps_tracker
  - platform: state
    entity_id: !input wifi_sensor
  - platform: homeassistant
    event: start
  - platform: event
    event_type: automation_reloaded

variables:
  gps_entity: !input gps_tracker
  wifi_entity: !input wifi_sensor
  
  ssid_input: !input home_ssids
  home_ssid_list: >
    {{ ssid_input.split(',') | map('trim') | list }}
  
  # -----------------------------------------------------------
  # AUTO-DISCOVERY & NAMING
  # -----------------------------------------------------------
  base_name: "{{ gps_entity.split('.')[1] }}"
  new_tracker_id: "{{ base_name }}_anchor"
  notify_service: "mobile_app_{{ base_name }}"
  
  batt_entity_id: "sensor.{{ base_name }}_battery_level"

  grace_sec: !input grace_period
  ping_sec: !input ping_delay
  
  # LIVE STATES
  current_ssid: "{{ states(wifi_entity) | default('unknown') }}"
  gps_state_is_home: "{{ states(gps_entity) == 'home' }}"
  
  # GUARDS
  batt_level: >
    {{ states(batt_entity_id) | int(default=100) }}
    
  # TIMESTAMPS
  wifi_time: "{{ as_timestamp(states[wifi_entity].last_changed) | default(0) }}"
  gps_time: "{{ as_timestamp(states[gps_entity].last_updated) | default(0) }}"

  # DATA SNAPSHOT
  gps_lat: "{{ state_attr(gps_entity, 'latitude') | default(0) }}"
  gps_long: "{{ state_attr(gps_entity, 'longitude') | default(0) }}"
  gps_acc: "{{ state_attr(gps_entity, 'gps_accuracy') | int(default=0) }}"
  
  home_lat: "{{ state_attr('zone.home', 'latitude') }}"
  home_long: "{{ state_attr('zone.home', 'longitude') }}"

action:
  - choose:
      # ----------------------------------------------------------------
      # SCENARIO 1: ANCHORED HOME (WiFi Connected)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ current_ssid in home_ssid_list }}"
        sequence:
          - service: device_tracker.see
            data:
              dev_id: "{{ new_tracker_id }}"
              location_name: home
              source_type: router
              gps: ["{{ home_lat }}", "{{ home_long }}"]
              gps_accuracy: 10

      # ----------------------------------------------------------------
      # SCENARIO 2: ALIEN NETWORK (Instant Away)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: >
              {{ current_ssid not in home_ssid_list 
                 and current_ssid != 'unknown' 
                 and current_ssid != 'unavailable'
                 and current_ssid != '<not connected>'
                 and current_ssid != 'Not Connected' }}
        sequence:
          # A. Force Update
          - service: device_tracker.see
            data:
              dev_id: "{{ new_tracker_id }}"
              location_name: not_home
              source_type: router
              gps: ["{{ gps_lat }}", "{{ gps_long }}"]
              # FIX: If GPS still says 'home' (stale), inflate accuracy to 2000.
              # Otherwise, use the real GPS accuracy.
              gps_accuracy: >
                {% if gps_state_is_home %} 2000 {% else %} {{ gps_acc }} {% endif %}

          # B. Self-Correction (New)
          # If the GPS was stale, we ping the phone now to get the REAL location
          # (e.g. update the map from 'House' to 'Starbucks').
          - if:
              - condition: template
                value_template: "{{ gps_state_is_home }}"
            then:
              - service: "notify.{{ notify_service }}"
                data:
                  message: "request_location_update"

      # ----------------------------------------------------------------
      # SCENARIO 3: DISCONNECTED (Potential Leaving)
      # ----------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ gps_state_is_home }}"
        sequence:
          - choose:
              # A. WiFi dropped RECENTLY -> Check Guards & Wait
              - conditions:
                  - condition: template
                    value_template: "{{ wifi_time > gps_time }}"
                sequence:
                  # 1. GUARD: Dead Battery? STOP.
                  - if:
                      - condition: template
                        value_template: "{{ batt_level < 5 }}"
                    then:
                      - stop: "Battery critical. Staying Anchored."
                  
                  # 2. WAIT 1: Grace Period (Router Reboot check)
                  - delay: "{{ grace_sec }}"
                  
                  # 3. MARK AWAY (Provisional)
                  - service: device_tracker.see
                    data:
                      dev_id: "{{ new_tracker_id }}"
                      location_name: not_home
                      source_type: router
                      gps: ["{{ gps_lat }}", "{{ gps_long }}"]
                      gps_accuracy: 2000

                  # 4. WAIT 2: Getaway Period (Drive away from house)
                  - delay: "{{ ping_sec }}"

                  # 5. VERIFY: Ping GPS now to confirm exact location.
                  - service: "notify.{{ notify_service }}"
                    data:
                      message: "request_location_update"

              # B. GPS updated RECENTLY -> Trust GPS
              - conditions:
                  - condition: template
                    value_template: "{{ gps_time > wifi_time }}"
                sequence:
                  - service: device_tracker.see
                    data:
                      dev_id: "{{ new_tracker_id }}"
                      location_name: home
                      source_type: gps
                      gps: ["{{ gps_lat }}", "{{ gps_long }}"]
                      gps_accuracy: "{{ gps_acc }}"

    # ----------------------------------------------------------------
    # SCENARIO 4: GPS SAYS AWAY (Pass-through)
    # ----------------------------------------------------------------
    default:
      - service: device_tracker.see
        data:
          dev_id: "{{ new_tracker_id }}"
          location_name: "{{ states(gps_entity) }}"
          source_type: gps
          gps: ["{{ gps_lat }}", "{{ gps_long }}"]
          gps_accuracy: "{{ gps_acc }}"
